# install_3rd_parties.sh 기준 설치 컴포넌트 검증 정의
# installer_id: 로그/보고서에서 구분용 (추후 installer 2 추가 시 확장)

installer_id: install_3rd_parties
installer_name: "3rd Party Components (PostgreSQL, Valkey, RabbitMQ, EMQ-X, NGINX, etc.)"

components:
  - id: timescaledb_postgresql
    name: "TimescaleDB (PostgreSQL 16)"
    order: 1
    checks:
      # (선택) postgresql.service 대신 아래 한 줄 헬스로 대체 가능
      - type: command
        cmd: "pg_lsclusters 2>/dev/null | grep -q online || systemctl list-units 'postgresql@*' --no-legend --plain 2>/dev/null | grep -q running"
        shell: true
        description: "PostgreSQL cluster/instance healthy (pg_lsclusters or postgresql@*)"
      - type: systemd
        unit: postgresql@16-main
      - type: journalctl
        unit: postgresql@16-main
        lines: 20
        description: "PostgreSQL recent logs"
      - type: command
        cmd: "pg_isready -U postgres -h localhost"
        description: "PostgreSQL ready"
      - type: path
        path: "/etc/postgresql/16/main/postgresql.conf"
        description: "postgresql.conf exists"

  - id: valkey
    name: "Valkey"
    order: 2
    checks:
      - type: systemd
        unit: valkey
      - type: journalctl
        unit: valkey
        lines: 20
        description: "Valkey recent logs"
      # PONG이어야 정상. MISCONF(디스크 저장 실패) 시 (error) 메시지 반환 → 실패로 검출
      - type: command
        cmd: "valkey-cli ping"
        expect_stdout: "PONG"
        description: "Valkey ping PONG (healthy)"

  - id: rabbitmq
    name: "RabbitMQ"
    order: 3
    checks:
      - type: systemd
        unit: rabbitmq-server
      - type: journalctl
        unit: rabbitmq-server
        lines: 20
        description: "RabbitMQ recent logs"
      - type: command
        cmd: "sudo rabbitmqctl list_users"
        expect_stdout_contains: "tapp"
        description: "RabbitMQ user tapp exists"

  - id: emqx
    name: "EMQ-X"
    order: 4
    checks:
      - type: systemd
        unit: emqx
      - type: journalctl
        unit: emqx
        lines: 20
        description: "EMQ-X recent logs"
      - type: path
        path: "/etc/emqx/emqx.conf"
        description: "emqx.conf exists"

  - id: nginx
    name: "NGINX"
    order: 5
    checks:
      - type: systemd
        unit: nginx
      - type: journalctl
        unit: nginx
        lines: 20
        description: "NGINX recent logs"
      # tapp 권한으로는 로그 경로 접근 불가 → 검증만 sudo로 실행
      - type: command
        cmd: "sudo nginx -t"
        description: "NGINX config test"

  - id: fluent_bit
    name: "fluent-bit"
    order: 6
    checks:
      - type: systemd
        unit: fluent-bit
      - type: journalctl
        unit: fluent-bit
        lines: 20
        description: "fluent-bit recent logs"
      # PATH에 없을 수 있음. 공식 install.sh=/opt/fluent-bit/bin, 패키지=/usr/bin
      - type: path_any
        paths: ["/opt/fluent-bit/bin/fluent-bit", "/usr/bin/fluent-bit"]
        description: "fluent-bit binary exists"

  - id: supervisor
    name: "Supervisor"
    order: 7
    checks:
      - type: systemd
        unit: supervisor
      - type: journalctl
        unit: supervisor
        lines: 20
        description: "Supervisor recent logs"

  - id: zip
    name: "Zip"
    order: 8
    checks:
      - type: command
        cmd: "which zip"
        description: "zip in PATH"

  - id: openjdk
    name: "OpenJDK (BellSoft Java 21)"
    order: 9
    checks:
      - type: command
        cmd: "java -version"
        expect_stdout_contains: "21"
        description: "Java 21"

  - id: nodejs
    name: "Node.js 20"
    order: 10
    checks:
      - type: command
        cmd: "node -v"
        expect_stdout_contains: "v20"
        description: "Node v20"

  - id: python3_venv
    name: "Python3 + venv & packages"
    order: 11
    checks:
      - type: command
        cmd: "python3 --version"
        description: "python3 available"
      - type: path
        path: "~/.venv/bin/python"
        expand_user: true
        description: "venv exists"
      - type: command
        cmd: "~/.venv/bin/python -c \"import psycopg, requests, yaml, pexpect\""
        shell: true
        description: "pip packages (psycopg, requests, PyYAML, pexpect)"

  - id: vsftpd
    name: "VSFTP"
    order: 12
    checks:
      - type: systemd
        unit: vsftpd
      - type: journalctl
        unit: vsftpd
        lines: 20
        description: "VSFTP recent logs"
      - type: path
        path: "/etc/vsftpd.conf"
        description: "vsftpd.conf exists"
      # 육상플랫폼 FTPS 포트 연결 가능 여부 (TCP 연결 성공 시 통과; implicit TLS가 아니면 openssl은 실패하므로 nc 사용)
      - type: command
        cmd: "timeout 10 nc -zv 4.217.184.21 12224 2>&1"
        shell: true
        description: "FTPS 육상플랫폼 연결 (4.217.184.21:12224)"
